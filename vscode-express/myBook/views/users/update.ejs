<div class="row my-5">
  <div class="col">
    <h1 class="text-center mb-5">회원정보수정</h1>
    <div class="card p-5">
      <form name="frm" method="post">
        <div class="input-group my-2">
          <div class="input-group-text px-5">성명</div>
          <input class="form-control" name="name" value="나잘난" />
        </div>
        <div class="input-group my-2">
          <div class="input-group-text px-5">주소</div>
          <input
            class="form-control"
            name="address"
            value="서울특별시 금천구 가산디지털2로 95 KM타워 3층 307호 Top Camp"
          />
        </div>
        <div class="input-group my-2">
          <div class="input-group-text px-5">전화</div>
          <input class="form-control" name="phone" value="010-1010-2020" />
        </div>
        <div>
          <img
            id="fileName"
            src="https://via.placeholder.com/200x200"
            width="30%"
          />
          <input class="form-control mt-2" type="file" name="file" />
        </div>
        <div class="text-center mt-3">
          <button class="btn-primary btn px-5">정보수정</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module" >
  import {app} from '/javascripts/firebase.js'
  import { getFirestore, setDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
  import { getStorage, uploadBytes, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
  const db = getFirestore(app)
  const storage =getStorage(app)
  const uid = localStorage.getItem('uid')

  // 이벤트처리!! 버튼이 눌렸을 때, db에 보내져야 함!
  $(frm).on('submit',async(event)=>{
    event.preventDefault() //버튼 서브밋으로 인한 새로고침 방지(사이드이펙트)
    if(window.confirm('회원정보를 변경하시겠습니까?')){
      let name = $(frm.name).val() //val() 사용자 입력 제목
      let address = $(frm.address).val() //val() 사용자 입력 
      let phone = $(frm.phone).val() //val() 사용자 입력 
      let email = localStorage.getItem('email') 
      //사진도 올릴래?
      if(frm.file.files[0]){
        const snapshot = await uploadBytes(
          ref(storage,'/photo/${Date.now()}.jpg'), frm.file.files[0])
      } //if 
      const url = await getDownloadURL(snapshot.ref)
      await setDoc(doc(db,`users/${uid}`),{
        email, name, address, phone, photo:url
      })
    }//if
    //사진이 있을 때만 처리된다. 
    //사진 수정 안 하는 경우, 기존의 정보에 url 다시 넣어주고, 안 넣으면 null
    else{
      const photo = $("#fileName").attr('src')
      await setDoc(doc(db,`users/${uid}`),{
        email, name, address, phone, photo
    })
  }//end of else
  //url 변경 -> 기존 요청 끊어지고 새로운 요청 발동됨 
  alert('사용자 정보가 변경되었습니다. ')
  location.href='/users/mypage'
  })//outer if
  $(frm.file).on('change',function(e){
  $("#fileName").attr('src',URL.createObjectURL(e.target.files[0]))
  })
</script>